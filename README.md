## About

**Gofed** is a tool set aimed at automation of packaging of golang projects and analysis of Go ecosystem.

**Per project support**:
* Spec file generator for the github.com, code.google.com, and bitbucket.org repositories
* Fedora's Review Request generator for new golang packages
* Comparison of APIs (exported symbols) of two golang projects
* Go source code analysis: dependency discovering (imported projects), tests and main packages detection
* Dependency approximation: approximate Godeps.json of your project 

**Per distribution support**:
* Multicommands: run scratch-builds, builds, updates, etc. on multiple branches with one command
* Update your package with one command using wizard
* Project snapshot checker: check current state of all dependencies of your project (up2date, outdated, missing)
* Spec file bumper: update you spec file just be specifying commit
* Create trackers for your Go projects in distribution
* Lint your spec file: detection of missing Provides, [Build]Requires

**Per ecosystem support**:
* Distribution analysis: dependency graph builders, new go project discovery


## Quick start

1. clone the repository
2. pull submodules
3. set up gofed
4. run gofed

```sh
$ git clone https://github.com/gofed/gofed; cd gofed
$ ./hack/pull-submodules.sh
$ ./hack/prep.sh
$ ./hack/gofed.sh
```

## Resource management

Some **gofed** commands require working with resources.
To provide transparent interface, commands accept resource declarations only.
Processed resources (source code tarball, rpms, etc.) may be stored
under local directories dependening on **gofed** system configuration.
Checkout ``infra.conf`` under ``third_party/gofed_infra/system/config`` directory.
By default, directories under ``/var/lib/gofed`` are expected.

Resources that has been processed are not cleaned automatically.
There are two ways how to provide cleaning mechanism:

* cleaning deamons
* one time command

### Cleaning deamons

Checkout ``gofed-resources-client.service`` and ``gofed-resources-provider.service`` under
``third_party/gofed_infra/system/daemons`` directory.
The services are meant to be run as user services as ``systemctl --start start gofed-resources-[client|provider].service``.
Before running the services make sure both are installed under ``/usr/lib/systemd/user`` directory.

Required service are generated by ``hack/prep.sh``.

### One time command

Optionally, the deamons can be replaced with ``gofed clean-resources`` command.
The command cleans all resources retrived by gofed.
On the other hand, the command has to be run manually everytime.

## Gofed land tour

Simple intro about the tools

### Spec file generator

One of the common use cases is to generate spec file.
The fastest way to generate one for a Go project (e.g. https://github.com/cpuguy83/go-md2man) is to run:

   ```vim
   $ gofed repo2spec --detect https://github.com/cpuguy83/go-md2man --commit 2724a9c9051aa62e9cca11304e7dd518e9e41599 -f --with-build
   ```

The project is already packaged in Fedora. Thus, use ``--force`` option too.

Output:
   ```vim
   Repo URL: github.com/cpuguy83/go-md2man
   Commit: 2724a9c9051aa62e9cca11304e7dd518e9e41599
   Name: golang-github-cpuguy83-go-md2man
   
   (1/4) Checking if the package already exists in PkgDB
   (2/4) Collecting data
   (3/4) Generating spec file
   (4/4) Discovering golang dependencies
   Discovering package dependencies
   	Class: github.com/russross/blackfriday (golang-github-russross-blackfriday) PkgDB=True
   
   Spec file golang-github-cpuguy83-go-md2man.spec at /tmp/test/golang-github-cpuguy83-go-md2man/fedora/golang-github-cpuguy83-go-md2man
   ```

At the beginning, golang checks the Fedora repository if the package already exists.
If not, it creates a spec file (needs to be filled for missing data),
retrieves tarball with source code,
and checks current state of all dependencies (classes of imports decomposed by a repository - common import path prefix).

The ``gofed repo2spec`` command generates spec file only.
To download project's tarball, change your working directory to
``/tmp/test/golang-github-cpuguy83-go-md2man/fedora/golang-github-cpuguy83-go-md2man``
and run ``gofed fetch --spec``:

   ```sh
   $ gofed fetch --spec
   Detecting spec file in the current directory...
   'golang-github-cpuguy83-go-md2man.spec' detected
   Parsing spec file
   ipprefix: github.com/cpuguy83/go-md2man
   commit: 2724a9c9051aa62e9cca11304e7dd518e9e41599
   Fetching https://github.com/cpuguy83/go-md2man/archive/2724a9c9051aa62e9cca11304e7dd518e9e41599/go-md2man-2724a9c.tar.gz ...
   ```

Spec file and tarball are ready for analyses.

### Dependency discovering

To discover imports and dependencies of the previous project, run the following command inside of the repository's tarball:

   ```vim
   $ tar -xf go-md2man-2724a9c.tar.gz
   $ cd go-md2man-2724a9c9051aa62e9cca11304e7dd518e9e41599
   $ gofed ggi -c -s -d -v
   ```

Output:

   ```vim
   Class: github.com/russross/blackfriday (golang-github-russross-blackfriday) PkgDB=True
   ```

When running with the -d option, gofed checks if the dependency is already packaged in the PkgDB database.
To show only dependencies that are not packaged in PkgDB, run the command without ``-v`` option.

When running ``gofed ggi`` without any options, list of all dependencies of devel part is hown:

```vim
   $ gofed ggi
	github.com/russross/blackfriday
```

To show all dependencies, run the command with ``--all-occurrences`` option:

```vim
$ gofed ggi --all-occurrences
	github.com/cpuguy83/go-md2man/md2man
	github.com/russross/blackfriday
```

### Check project dependencies in Fedora

To check if all dependencies of a package are up-to-date in Fedora (for example etcd), run the following command on the package's Godeps.json file:

   ```vim
   $ gofed check-deps --godeps Godeps.json
   ```

Output:

   ```vim
   github.com/spf13/cobra is newer in distribution
   github.com/kballard/go-shellquote is up-to-date
   github.com/matttproud/golang_protobuf_extensions is newer in distribution
   golang.org/x/crypto is newer in distribution
   golang.org/x/net is up-to-date
   github.com/codegangsta/cli is newer in distribution
   github.com/beorn7/perks is up-to-date
   github.com/russross/blackfriday is up-to-date
   github.com/coreos/go-systemd is newer in distribution
   bitbucket.org/ww/goautoneg is up-to-date
   github.com/shurcooL/sanitized_anchor_name is up-to-date
   github.com/olekukonko/tablewriter is up-to-date
   github.com/olekukonko/ts is up-to-date
   github.com/google/btree is up-to-date
   github.com/gogo/protobuf is up-to-date
   ...
   ```

By default, rawhide distribution is checked.

To speed-up the check, it is recommended to scan distribution first (see below).

### Distribution analysis

#### Scan distribution for available projects

To scan the distribution for available Go projects, run the following command:

   ```vim
   $ gofed scan-distro -v
   ```

The command checks the distribution (Fedora rawhide by default) for all Go projects
packaged in distribution with the generic name prefixed with ``golang-*``.
To provide a list of additional package, use ``--custom-packages`` option.
Then, the list of the latest builds for packages is retrieved.
Data from the builds are extracted and ready for analysis.

Data retrieved by ``gofed scan-distro`` are usually prerequisite for other scans such as:

* ``gofed scan-packages``
* ``gofed scan-deps``

or checks:

* ``gofed check-deps``
    
#### Golang dependency graph

To display a dependency graph for a package, for example docker-io, run:

   ```vim
   $ gofed scan-deps -v -g -o docker.png docker
   ```

This command generates a PNG picture, in this case named docker.png, with the dependency graph.

![docker-io dependencies](https://raw.githubusercontent.com/ingvagabund/GolangPackageGenerator/master/docker.png)

#### Golang project decomposition

To display a decomposition of a project into a dependency graph, for example [prometheus](https://github.com/prometheus/prometheus), run the following command in project's directory:

   ```vim
   $ gofed scan-deps -v -d github.com/prometheus/prometheus --from-dir . -g -o prometheus.png
   ```

This command generates a PNG picture, in this case named prometheus.png, with the dependency graph.

![prometheus decomposition](https://raw.githubusercontent.com/ingvagabund/GolangPackageGenerator/master/prometheus.png)


#### API check

To see differences in exported symbols between two releases, commits, or versions of the same project, use the "gofed apidiff" command in the following format:

   ```vim
   $ gofed apidiff --reference="upstream:project[:commit]" --compare-with="upstream:project[:commit]"
   ```

For example, to check API of etcd between etcd-2.3.3 and etcd-2.2.4, run:

   ```vim
   $ gofed apidiff --reference="upstream:github.com/coreos/etcd:c41345d393002e87ae9e7023234b1c1e04ba9626" --compare-with="upstream:github.com/coreos/etcd:bdee27b19e8601ffd7bd4f0481abe9bbae04bd09"
   ```
Commit ``c41345d393002e87ae9e7023234b1c1e04ba9626`` correponds to ``etcd-v2.3.3``, commit ``bdee27b19e8601ffd7bd4f0481abe9bbae04bd09`` to ``etcd-v2.2.4``.

   
   Output
   
   ```vim
   -etcdctlv3/command: function removed: NewDeleteRangeCommand
   -etcdctlv3/command: function removed: NewRangeCommand
   -etcdserver/api/v3rpc: function removed: New
   -etcdserver/api/v3rpc: function removed: handler.Compact
   -etcdserver/api/v3rpc: function removed: handler.DeleteRange
   -etcdserver/api/v3rpc: function removed: handler.Put
   -etcdserver/api/v3rpc: function removed: handler.Range
   -etcdserver/api/v3rpc: function removed: handler.Txn
   ...
   ```
   
   To get new symbols and other information, use the -a option:
   
   ```vim
   ...
   +etcdctlv3/command: new function: NewGetCommand
   +etcdctlv3/command: new function: simplePrinter.Get
   +etcdctlv3/command: new function: NewCompactionCommand
   +etcdctlv3/command: new function: simplePrinter.Watch
   ~etcdctlv3/command: function updated: -type differs: selector != pointer
   ~etcdctlv3/command: function updated: -type differs: selector != pointer
   -etcdctlv3/command: function removed: NewDeleteRangeCommand
   -etcdctlv3/command: function removed: NewRangeCommand
   +etcdctlv3/command: new variable: ExitIO
   +etcdctlv3/command: new variable: ExitInvalidInput
   +etcdctlv3/command: new variable: ExitBadArgs
   +etcdctlv3/command: new variable: ExitError
   +etcdctlv3/command: new variable: ExitBadConnection
   ...
   ```
   
Lines starting with the minus symbol ("-") are breaking backward compatibility.
Lines starting with the plus symbol ("+") are new.
Lines starting with the tilda symbol ("~") are updated.

#### gofed-web client

To use gofed-web service, use "gofed client" command. You can query regularly
updated database of APIdiffs to speed up APIdiff inspections.


To see all available projects with APIdiff trend sorted alphabetically, use:

   ```vim
   $ gofed client -l --FMT "full_name:trend" | sort
   ```

   Output:

   ```vim
    cadvisor                                              165
    docker-io                                             123
    etcd                                                  219
    fleet                                                   5
    golang-bitbucket-kardianos-osext                       18
    golang-bitbucket-ww-goautoneg                           0
    ...
   ```

To see last two commits in project cadvisor and their API affection, use:

   ```vim
   $ gofed client -p cadvisor -m -q 2 -J 
   ```

   ```vim
   [
     {
       "added": [],
       "author": "Vish Kannan <vishh@users.noreply.github.com>",
       "commit": "769738ba88e4568b47c1fe7fadfe9cb56cb4b19c",
       "commit_msg": "Merge pull request #884 from hacpai/fixbug-issue-88",
       "date": "2015-09-17 17:52:56+00:00",
       "modified": [
         {
           "change": "function New: parameter count changed: 4 -> 5",
           "package": "storage/elasticsearch"
         }
       ]
     },
     {
       "added": [],
       "author": "Vish Kannan <vishh@users.noreply.github.com>",
       "commit": "7327cfe267570e73e0f419e66a97b1f0811d0034",
       "commit_msg": "Merge pull request #885 from rjnagal/docke",
       "date": "2015-09-15 18:49:53+00:00",
       "modified": []
     }
   ]
   ```
See "gofed client --help" for more info and available commands.

